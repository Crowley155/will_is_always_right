<!DOCTYPE html>
<html>
<head>
    <title>Salesforce Flow Launcher - Direct Auth</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style>
        body { 
            font-family: Arial, sans-serif; 
            margin: 20px; 
            background-color: #f4f6f9; 
        }
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.1); 
        }
        .flow-container { 
            min-height: 500px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            padding: 20px; 
        }
        .status { 
            margin: 10px 0; 
            padding: 10px; 
            border-radius: 4px; 
        }
        .status.info { 
            background: #e8f3ff; 
            border: 1px solid #0070d2; 
        }
        .status.success { 
            background: #e8f7e8; 
            border: 1px solid #28a745; 
        }
        .status.error { 
            background: #ffe8e8; 
            border: 1px solid #dc3545; 
        }
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Salesforce Flow Launcher - Direct Authentication</h1>
        
        <!-- Flow Section -->
        <div id="flowSection">
            <h2>Sales Order Acquisition Workflow</h2>
            <div id="flowContainer" class="flow-container">
                <div id="flowStatus" class="status info">
                    <span class="loading"></span> Authenticating with Salesforce...
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Configuration
        const CONFIG = {
            clientId: '3MVG9fdJGowvdgN3cVEc2VfzZPUcpVNgO4rmsXGujU25k4uFLOtXlPUm0ETdo_vaUWw_GK7U6DsTtPCcZk_0X',
            username: 'flow@clearcaptions.com.willdev',
            password: 'hFkO4qcWyWM%FgtOJnNgqtNDPfWKvsw9E6UG32dbO', // password + security token
            loginUrl: 'https://clearcaptions123--willdev.sandbox.my.salesforce-setup.com/services/oauth2/token',
            instanceUrl: 'https://clearcaptions123--willdev.sandbox.my.salesforce-setup.com',
            flowName: 'Sales_Order_Acquisition_Guided_Workflow',
            apiVersion: 'v60.0'
        };
        
        let accessToken = null;
        let instanceUrl = null;
        
        // Update status
        function updateFlowStatus(message, type = 'info', showLoading = false) {
            const statusEl = document.getElementById('flowStatus');
            const loadingSpinner = showLoading ? '<span class="loading"></span> ' : '';
            statusEl.innerHTML = loadingSpinner + message;
            statusEl.className = `status ${type}`;
            console.log(`[FLOW] ${message}`);
        }
        
        // Direct OAuth authentication
        async function authenticateDirectly() {
            try {
                updateFlowStatus('Authenticating with Salesforce...', 'info', true);
                
                const authBody = new URLSearchParams({
                    grant_type: 'password',
                    client_id: CONFIG.clientId,
                    username: CONFIG.username,
                    password: CONFIG.password
                });
                
                const response = await fetch(CONFIG.loginUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: authBody
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Authentication failed: ${response.status} - ${errorData}`);
                }
                
                const data = await response.json();
                
                if (data.access_token) {
                    accessToken = data.access_token;
                    instanceUrl = data.instance_url || CONFIG.instanceUrl;
                    
                    updateFlowStatus('‚úÖ Authentication successful! Launching flow...', 'success', true);
                    await launchFlow();
                    
                } else {
                    throw new Error('No access token received');
                }
                
            } catch (error) {
                updateFlowStatus(`‚ùå Authentication failed: ${error.message}`, 'error');
                console.error('Auth Error:', error);
            }
        }
        
        // Launch flow using REST API
        async function launchFlow() {
            try {
                updateFlowStatus('Starting flow execution...', 'info', true);
                
                const flowEndpoint = `${instanceUrl}/services/data/${CONFIG.apiVersion}/actions/custom/flow/${CONFIG.flowName}`;
                
                const flowBody = {
                    inputs: [{}] // Empty inputs for this flow
                };
                
                const response = await fetch(flowEndpoint, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${accessToken}`,
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(flowBody)
                });
                
                if (!response.ok) {
                    const errorData = await response.text();
                    throw new Error(`Flow execution failed: ${response.status} - ${errorData}`);
                }
                
                const result = await response.json();
                console.log('Flow Result:', result);
                
                updateFlowStatus('‚úÖ Flow completed successfully!', 'success');
                
                // Display results
                if (result && result.length > 0) {
                    const flowResult = result[0];
                    const resultHtml = `
                        <div style="margin-top: 20px;">
                            <h3>Flow Execution Results:</h3>
                            <pre style="background: #f8f9fa; padding: 15px; border-radius: 4px; overflow-x: auto;">
                                ${JSON.stringify(flowResult, null, 2)}
                            </pre>
                        </div>
                    `;
                    
                    document.getElementById('flowContainer').innerHTML = 
                        document.getElementById('flowContainer').innerHTML + resultHtml;
                }
                
            } catch (error) {
                updateFlowStatus(`‚ùå Flow execution failed: ${error.message}`, 'error');
                console.error('Flow Error:', error);
            }
        }
        
        // Start authentication when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üöÄ Starting Direct Flow Launcher');
            authenticateDirectly();
        });
        
        // Global error handling
        window.addEventListener('error', function(e) {
            console.error('Global error:', e.error);
            updateFlowStatus(`‚ùå Error: ${e.message}`, 'error');
        });
    </script>
</body>
</html> 
